name: Test AIO Installscript

on:
  push:
    paths:
      - '0-aio_installscript-vm.sh'
      - '0-aio_installscript-lxc.sh'
      - '.github/workflows/test-aio-installscript.yml'
      - 'scripts/**'
  pull_request:
    paths:
      - '0-aio_installscript-vm.sh'
      - '0-aio_installscript-lxc.sh'
      - '.github/workflows/test-aio-installscript.yml'
      - 'scripts/**'
  workflow_dispatch:
    inputs:
      run-vm:
        description: "Run VM tests"
        required: true
        default: "yes"
        type: choice
        options:
          - "yes"
          - "no"
      run-lxc:
        description: "Run LXC tests"
        required: true
        default: "yes"
        type: choice
        options:
          - "yes"
          - "no"
      os:
        description: "Ubuntu Version to test (e.g. 20.04)"
        required: true
        default: "_all"
        type: string


concurrency:
  group: ${{ (github.event_name == 'pull_request') && github.workflow && '-' && github.event.pull_request.number || github.workflow }}
  cancel-in-progress: ${{ (github.event_name == 'pull_request') && true || false }}

jobs:
  generate-matrix:
    runs-on: ubuntu-slim
    outputs:
      os: ${{ steps.parse.outputs.os }}
    steps:
      - name: list
        id: list
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.os }}" != "_all" ]; then \
            OSLIST="
            ${{ github.event.inputs.os }}
            "
          else
            OSLIST="
            20.04
            22.04
            24.04
            "
          fi
          echo "oslist<<EOF" >> $GITHUB_OUTPUT
          echo "$OSLIST" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: parse
        id: parse
        run: |
          OSLIST="${{ steps.list.outputs.oslist }}"
          OSLIST_JSON=$(echo "$OSLIST" | awk 'NF {printf "\"%s\",", $0}' | sed 's/,$//')
          echo "os=[$OSLIST_JSON]" >> $GITHUB_OUTPUT
          echo "################################################################"
          echo "OSLIST_JSON=[$OSLIST_JSON]"

  test-vm:
    runs-on: ubuntu-24.04
    if: ${{ !cancelled() && github.event.inputs.run-vm != 'no' }}
    needs: [ generate-matrix ]
    strategy:
      fail-fast: false
      matrix:
        ubuntu: ${{ fromJson(needs.generate-matrix.outputs.os) }}
    steps:

      - &sleep
        name: sleep
        shell: sh
        run: |
          SLEEP="$((1 + $(od -A n -t d -N 2 /dev/urandom | tr -d ' ') % 9))"
          echo "Sleeping $SLEEP seconds ..."
          sleep $SLEEP
  
      - name: env
        id: env
        run: |
          export TIMESTAMP="$(date -u +%Y%m%d_%H%M%S)"
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "################################################################" && bash -c "echo TIMESTAMP=$TIMESTAMP"
  
      - &clone
        name: clone
        uses: actions/checkout@main

      - name: source
        run: |
          # Add HashiCorp repository
          echo "Installing source for vagrant"
          wget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          # Add Oracle VirtualBox repository
          echo "Installing source for virtualbox"
          wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo gpg --dearmor -o /usr/share/keyrings/oracle-vbox-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/oracle-vbox-archive-keyring.gpg] https://download.virtualbox.org/virtualbox/debian $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) contrib" | sudo tee /etc/apt/sources.list.d/virtualbox.list

      - name: update
        run: |
          sudo apt-get update

      - name: install
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get install -y virtualbox-7.0 vagrant

      - name: create
        env:
          VAGRANT_CLOUDIMG_PROVIDER: alvistack
        run: |
          cat <<'EOF' > Vagrantfile
          Vagrant.configure("2") do |config|
            config.vm.box = "${{ env.VAGRANT_CLOUDIMG_PROVIDER }}/ubuntu-${{ matrix.ubuntu }}"
            host_cpus = begin
              require 'etc'
              Etc.nprocessors
            rescue
              1
            end
            host_memory_mb = begin
              if File.exist?('/proc/meminfo')
                # Linux
                mem_kb = File.read('/proc/meminfo')[/MemTotal:\s+(\d+)/, 1].to_i
                (mem_kb / 1024) / 2
              else
                # macOS
                mem_bytes = `sysctl -n hw.memsize`.to_i
                (mem_bytes / 1024 / 1024) / 2
              end
            rescue
              1024
            end
            host_memory_mb = [[host_memory_mb, 2048].max, 16384].min
            config.vm.provider "virtualbox" do |vb|
              vb.memory = host_memory_mb
              vb.cpus = host_cpus
            end
            config.vm.provision "file", source: "0-aio_installscript-vm.sh", destination: "/home/vagrant/0-aio_installscript-vm.sh"
            config.vm.provision "shell", inline: "chmod +x /home/vagrant/0-aio_installscript-vm.sh && sudo /home/vagrant/0-aio_installscript-vm.sh                | tee /home/vagrant/log_vm-install.log"
            config.vm.provision "shell", inline: "sleep 20s && sudo bash -c 'systemctl status fivemserver fivemupdater fivembackup fivemdbbackup && docker ps -a' | tee /home/vagrant/log_vm-running.log"
          end
          EOF

      - name: cache
        uses: actions/cache@main
        with:
          path: |
            ~/.vagrant.d/boxes
          key: ${{ github.job }}-${{ matrix.ubuntu }}-vagrant-${{ steps.env.outputs.timestamp }}
          restore-keys: |
            ${{ github.job }}-${{ matrix.ubuntu }}-vagrant-

      - name: run
        run: |
          vagrant up

      - name: collect
        if: always()
        run: |
          vagrant ssh -c "cat /home/vagrant/log_vm-install.log" > log_vm-install.log || true
          vagrant ssh -c "cat /home/vagrant/log_vm-running.log" > log_vm-running.log || true

      - name: log
        if: always()
        uses: actions/upload-artifact@main
        with:
          name: ${{ github.job }}-${{ matrix.ubuntu }}-logs
          path: log_vm-*.log

      - name: destroy
        if: always()
        run: |
          vagrant destroy -f

  test-lxc:
    runs-on: ubuntu-24.04
    if: ${{ !cancelled() && github.event.inputs.run-lxc != 'no' }}
    needs: [ generate-matrix ]
    strategy:
      fail-fast: false
      matrix:
        ubuntu: ${{ fromJson(needs.generate-matrix.outputs.os) }}
    steps:

      - *sleep

      - *clone

      - name: setup
        uses: canonical/setup-lxd@main
        with:
          preseed: |
            networks:
            - name: lxdbr0
              type: bridge
              config:
                ipv4.address: auto
                ipv6.address: none

      - name: init
        run: |
          sudo lxd init --auto

      - name: create
        run: |
          sudo lxc init ubuntu:${{ matrix.ubuntu }} fxserver-test
          sudo lxc network attach lxdbr0 fxserver-test eth0

      - name: start
        run: |
          sudo lxc start fxserver-test
          sleep 10

      - name: copy
        run: |
          sudo lxc file push 0-aio_installscript-lxc.sh fxserver-test/root/0-aio_installscript-lxc.sh

      - name: run
        run: |
          sudo lxc exec fxserver-test -- bash -c "chmod +x /root/0-aio_installscript-lxc.sh && /root/0-aio_installscript-lxc.sh                    | tee /root/log_lxc-install.log"
          sudo lxc exec fxserver-test -- bash -c "sleep 20s && systemctl status fivemserver fivemupdater fivembackup fivemdbbackup apache2 mariadb | tee /root/log_lxc-running.log"

      - name: collect
        if: always()
        run: |
          sudo lxc file pull fxserver-test/root/log_lxc-install.log log_lxc-install.log || true
          sudo lxc file pull fxserver-test/root/log_lxc-running.log log_lxc-running.log || true

      - name: log
        if: always()
        uses: actions/upload-artifact@main
        with:
          name: ${{ github.job }}-${{ matrix.ubuntu }}-logs
          path: log_lxc-*.log

      - name: destroy
        if: always()
        run: |
          sudo lxc stop fxserver-test
          sudo lxc delete fxserver-test --force
