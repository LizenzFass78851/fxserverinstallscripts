name: Test AIO Installscript

on:
  push:
    paths:
      - '0-aio_installscript-vm.sh'
      - '0-aio_installscript-lxc.sh'
      - '.github/workflows/test-aio-installscript.yml'
      - 'scripts/**'
  pull_request:
    paths:
      - '0-aio_installscript-vm.sh'
      - '0-aio_installscript-lxc.sh'
      - '.github/workflows/test-aio-installscript.yml'
      - 'scripts/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.base.repo.name && github.event.pull_request.number || github.repository }}
  cancel-in-progress: true

jobs:
  test-vm:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ubuntu: [24.04, 22.04]
    steps:

      - name: sleep
        run: |
          SLEEP="$((1 + $(od -A n -t d -N 2 /dev/urandom | tr -d ' ') % 9))"
          echo "Sleeping $SLEEP seconds ..."
          sleep $SLEEP
  
      - name: key
        id: key
        run: |
          export TIMESTAMP="$(date -u +%Y%m%d_%H%M%S)"
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "################################################################" && bash -c "echo TIMESTAMP=$TIMESTAMP"
  
      - name: clone
        uses: actions/checkout@main

      - name: source
        run: |
          # Add HashiCorp repository
          echo "Installing source for vagrant"
          wget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list

      - name: update
        run: |
          sudo apt-get update

      - name: install
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get install -y virtualbox vagrant

      - name: create
        run: |
          cat <<'EOF' > Vagrantfile
          Vagrant.configure("2") do |config|
            config.vm.box = "cloud-image/ubuntu-${{ matrix.ubuntu }}"
            host_cpus = begin
              require 'etc'
              Etc.nprocessors
            rescue
              1
            end
            config.vm.provider "virtualbox" do |vb|
              vb.memory = "2048"
              vb.cpus = host_cpus
            end
            config.vm.provision "file", source: "0-aio_installscript-vm.sh", destination: "/home/vagrant/0-aio_installscript-vm.sh"
            config.vm.provision "shell", inline: "chmod +x /home/vagrant/0-aio_installscript-vm.sh && sudo /home/vagrant/0-aio_installscript-vm.sh                | tee /home/vagrant/log_vm-install.log"
            config.vm.provision "shell", inline: "sleep 10s && sudo bash -c 'systemctl status fivemserver fivemupdater fivembackup fivemdbbackup && docker ps -a' | tee /home/vagrant/log_vm-running.log"
          end
          EOF

      - name: cache
        uses: actions/cache@main
        with:
          path: |
            ~/.vagrant.d/boxes
          key: ${{ github.job }}-${{ matrix.ubuntu }}-vagrant-${{ steps.key.outputs.timestamp }}
          restore-keys: |
            ${{ github.job }}-${{ matrix.ubuntu }}-vagrant-

      - name: run
        run: |
          vagrant up

      - name: collect
        if: always()
        run: |
          vagrant ssh -c "cat /home/vagrant/log_vm-install.log" > log_vm-install.log || true
          vagrant ssh -c "cat /home/vagrant/log_vm-running.log" > log_vm-running.log || true

      - name: log
        if: always()
        uses: actions/upload-artifact@main
        with:
          name: ${{ github.job }}-${{ matrix.ubuntu }}-logs
          path: log_vm-*.log

      - name: destroy
        if: always()
        run: |
          vagrant destroy -f

  test-lxc:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ubuntu: [24.04, 22.04]
    steps:

      - name: sleep
        run: |
          SLEEP="$((1 + $(od -A n -t d -N 2 /dev/urandom | tr -d ' ') % 9))"
          echo "Sleeping $SLEEP seconds ..."
          sleep $SLEEP

      - name: clone
        uses: actions/checkout@main

      - name: setup
        uses: canonical/setup-lxd@main
        with:
          preseed: |
            networks:
            - name: lxdbr0
              type: bridge
              config:
                ipv4.address: auto
                ipv6.address: none

      - name: init
        run: |
          sudo lxd init --auto

      - name: create
        run: |
          sudo lxc init ubuntu:${{ matrix.ubuntu }} fxserver-test
          sudo lxc network attach lxdbr0 fxserver-test eth0

      - name: start
        run: |
          sudo lxc start fxserver-test
          sleep 10

      - name: copy
        run: |
          sudo lxc file push 0-aio_installscript-lxc.sh fxserver-test/root/0-aio_installscript-lxc.sh

      - name: run
        run: |
          sudo lxc exec fxserver-test -- bash -c "chmod +x /root/0-aio_installscript-lxc.sh && /root/0-aio_installscript-lxc.sh                    | tee /root/log_lxc-install.log"
          sudo lxc exec fxserver-test -- bash -c "sleep 10s && systemctl status fivemserver fivemupdater fivembackup fivemdbbackup apache2 mariadb | tee /root/log_lxc-running.log"

      - name: collect
        if: always()
        run: |
          sudo lxc file pull fxserver-test/root/log_lxc-install.log log_lxc-install.log || true
          sudo lxc file pull fxserver-test/root/log_lxc-running.log log_lxc-running.log || true

      - name: log
        if: always()
        uses: actions/upload-artifact@main
        with:
          name: ${{ github.job }}-${{ matrix.ubuntu }}-logs
          path: log_lxc-*.log

      - name: destroy
        if: always()
        run: |
          sudo lxc stop fxserver-test
          sudo lxc delete fxserver-test --force
